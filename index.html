<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task AI Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #777777);
            --link-color: var(--tg-theme-link-color, #007aff);
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --input-bg-color: var(--tg-theme-secondary-bg-color, #ffffff);
            --input-border-color: var(--tg-theme-hint-color, #e0e0e0);
            --chat-bg-color: var(--tg-theme-bg-color, #f8f8f8);
            --user-bubble-color: var(--tg-theme-link-color, #007aff);
            --ai-bubble-color: var(--tg-theme-secondary-bg-color, #e5e5ea);
            --user-text-color: var(--tg-theme-bg-color, #ffffff);
            --ai-text-color: var(--tg-theme-text-color, #000000);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.16);
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: var(--tg-theme-bg-color, #1a1a1a);
                --secondary-bg-color: var(--tg-theme-secondary-bg-color, #2a2a2a);
                --text-color: var(--tg-theme-text-color, #ecf0f1);
                --hint-color: var(--tg-theme-hint-color, #aaa);
                --input-bg-color: var(--tg-theme-secondary-bg-color, #3a3a3a);
                --input-border-color: var(--tg-theme-hint-color, #4a4a4a);
                --chat-bg-color: var(--tg-theme-bg-color, #1a1a1a);
                --ai-bubble-color: var(--tg-theme-secondary-bg-color, #3a3a3a);
                --user-text-color: var(--tg-theme-bg-color, #ffffff);
                --ai-text-color: var(--tg-theme-text-color, #ecf0f1);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            transition: background-color var(--transition-normal), color var(--transition-normal);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes loading {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* –°—Ç–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        .page-header {
            font-size: 1.6em;
            margin: 15px 15px 25px 15px;
            padding-bottom: 5px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--link-color) 30%, #4a90e2 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-bottom: 2px solid var(--input-border-color);
            animation: fadeIn 0.6s ease-out;
        }

        .content-padding {
            padding: 0 15px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–¥–∞—á */
        #tasks-view {
            padding-bottom: 80px;
        }
        
        .form-section {
            background: transparent;
            margin: 0 15px 20px 15px;
            overflow: hidden;
            transition: all var(--transition-normal);
            max-height: 60px;
            border-radius: 16px;
            opacity: 0.95;
        }
        
        .form-section.expanded {
            max-height: 500px;
            opacity: 1;
            animation: slideInRight 0.4s ease-out;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 20px;
            height: 60px;
            background: var(--secondary-bg-color);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .form-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left var(--transition-slow);
        }
        
        .form-header:hover::before {
            left: 100%;
        }
        
        .form-header:hover {
            background: color-mix(in srgb, var(--secondary-bg-color) 90%, var(--link-color) 10%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .form-section.expanded .form-header {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            box-shadow: none;
        }
        
        .form-section-content {
            padding: 0;
            opacity: 0;
            transform: translateY(-10px);
            transition: all var(--transition-normal);
            height: 0;
            overflow: hidden;
            background: var(--input-bg-color);
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }
        
        .form-section.expanded .form-section-content {
            opacity: 1;
            transform: translateY(0);
            height: auto;
            padding: 20px 0;
            box-shadow: var(--shadow-md);
            animation: slideInRight 0.3s ease-out 0.1s both;
        }
        
        .ios-group {
            border-radius: 12px;
            overflow: hidden;
            margin: 0 15px;
        }
        
        .ios-row {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--input-border-color);
            background: var(--input-bg-color);
            min-height: 44px;
            transition: background-color var(--transition-fast);
        }
        
        .ios-row:focus-within {
            background: color-mix(in srgb, var(--input-bg-color) 90%, var(--link-color) 10%);
        }
        
        .ios-row:last-child {
            border-bottom: none;
        }
        
        .ios-label {
            color: var(--text-color);
            font-size: 1em;
            font-weight: 400;
            flex-shrink: 0;
            width: 100px;
            margin-right: 15px;
            opacity: 0.9;
        }
        
        .ios-row input,
        .ios-row select {
            flex-grow: 1;
            padding: 0;
            margin: 0;
            background: transparent;
            color: var(--text-color);
            border: none;
            outline: none;
            font-size: 1em;
            text-align: right;
            -webkit-appearance: none;
            appearance: none;
            transition: color var(--transition-fast);
        }
        
        .ios-row input:focus,
        .ios-row select:focus {
            color: var(--link-color);
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–¥–∞—á —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ */
        .task-card {
            border-left: 6px solid;
            padding: 18px;
            margin: 0 15px 15px 15px;
            border-radius: 16px;
            background: var(--secondary-bg-color);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            animation: fadeIn 0.4s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .task-card:hover::before {
            opacity: 1;
            animation: shimmer 2s infinite;
        }
        
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .task-card:active {
            transform: translateY(-1px);
            transition: transform var(--transition-fast);
        }
        
        .task-card.high { border-left-color: var(--danger-color); }
        .task-card.medium { border-left-color: var(--warning-color); }
        .task-card.low { border-left-color: var(--success-color); }
        
        .task-card.expired {
            animation: pulse 2s infinite;
            border-left-color: #95a5a6;
            opacity: 0.7;
        }
        
        .task-card.removing {
            animation: slideInLeft 0.3s ease-in reverse forwards;
            opacity: 0;
            transform: translateX(-20px);
        }
        
        .task-info {
            flex-grow: 1;
            margin-right: 15px;
            animation: fadeIn 0.5s ease-out 0.1s both;
        }
        
        .task-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        .importance-tag {
            font-size: 0.7em;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }
        
        .importance-tag.high {
            background: color-mix(in srgb, var(--danger-color) 20%, transparent);
            color: var(--danger-color);
        }
        
        .importance-tag.medium {
            background: color-mix(in srgb, var(--warning-color) 20%, transparent);
            color: var(--warning-color);
        }
        
        .importance-tag.low {
            background: color-mix(in srgb, var(--success-color) 20%, transparent);
            color: var(--success-color);
        }
        
        .task-text {
            font-weight: 600;
            font-size: 1.1em;
            line-height: 1.4;
            word-wrap: break-word;
            flex-grow: 1;
            transition: color var(--transition-fast);
        }
        
        .task-card p {
            font-size: 0.9em;
            color: var(--hint-color);
            margin: 8px 0 0 0;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color var(--transition-fast);
        }
        
        /* –ú–µ–Ω—é —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .menu-button {
            background: transparent;
            border: none;
            color: var(--hint-color);
            font-size: 1.5em;
            padding: 0 8px;
            line-height: 1;
            cursor: pointer;
            align-self: flex-start;
            margin-top: -5px;
            position: relative;
            z-index: 1001;
            transition: all var(--transition-fast);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-button:hover {
            background: var(--input-bg-color);
            color: var(--text-color);
            transform: rotate(90deg);
            animation: bounce 0.5s ease;
        }
        
        .menu-button:active {
            transform: scale(0.9);
        }
        
        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        #context-menu {
            position: fixed;
            background: var(--secondary-bg-color);
            border-radius: 14px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none;
            overflow: hidden;
            min-width: 220px;
            animation: fadeIn 0.2s ease-out;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-item {
            padding: 14px 18px;
            font-size: 0.95em;
            cursor: pointer;
            color: var(--text-color);
            border-bottom: 1px solid var(--input-border-color);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }
        
        .menu-item:hover::before {
            left: 100%;
        }
        
        .menu-item:hover {
            background-color: color-mix(in srgb, var(--secondary-bg-color) 85%, var(--link-color) 15%);
            padding-left: 22px;
        }
        
        .menu-item:active {
            transform: scale(0.98);
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .delete-item {
            color: var(--danger-color);
        }
        
        /* –ß–∞—Ç —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ */
        #ai-view {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100vh;
            padding: 0;
            padding-bottom: 80px;
        }
        
        #chat-content-wrapper {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            scroll-behavior: smooth;
        }
        
        #chat-input-container {
            position: fixed;
            bottom: 70px;
            left: 0;
            width: 100%;
            background: var(--bg-color);
            padding: 15px;
            box-sizing: border-box;
            border-top: 1px solid var(--input-border-color);
            z-index: 99;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: slideInRight 0.3s ease-out;
        }
        
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #ai-prompt-input {
            flex-grow: 1;
            padding: 12px 18px;
            border-radius: 25px;
            background: var(--input-bg-color);
            border: 1px solid var(--input-border-color);
            color: var(--text-color);
            font-size: 1em;
            transition: all var(--transition-fast);
            outline: none;
        }
        
        #ai-prompt-input:focus {
            border-color: var(--link-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--link-color) 30%, transparent);
        }
        
        #send-prompt-btn {
            padding: 12px 20px;
            border-radius: 25px;
            background: linear-gradient(135deg, var(--link-color), #4a90e2);
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        #send-prompt-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            animation: pulse 1s infinite;
        }
        
        #send-prompt-btn:active {
            transform: translateY(0);
        }
        
        #send-prompt-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* –ü—É–∑—ã—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ */
        .message-bubble {
            max-width: 85%;
            padding: 14px 18px;
            margin: 10px 0;
            border-radius: 20px;
            font-size: 0.95em;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            animation: fadeIn 0.3s ease-out;
            position: relative;
            transition: transform var(--transition-fast);
        }
        
        .message-bubble:hover {
            transform: translateY(-2px);
        }
        
        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--user-bubble-color), color-mix(in srgb, var(--user-bubble-color) 80%, white));
            color: var(--user-text-color);
            border-bottom-right-radius: 5px;
            animation: slideInLeft 0.3s ease-out;
        }
        
        .ai-message {
            align-self: flex-start;
            background: var(--ai-bubble-color);
            color: var(--ai-text-color);
            border-bottom-left-radius: 5px;
            animation: slideInRight 0.3s ease-out;
        }
        
        .ai-greeting {
            background: transparent;
            color: var(--hint-color);
            text-align: center;
            margin: 20px auto;
            font-style: italic;
            box-shadow: none;
            animation: fadeIn 0.8s ease-out;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è AI */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 15px;
            background: var(--ai-bubble-color);
            border-radius: 20px;
            width: fit-content;
            margin: 10px 0;
            animation: fadeIn 0.3s ease-out;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--hint-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ */
        .view {
            display: none;
            flex-grow: 1;
            animation: fadeIn 0.4s ease-out;
        }
        
        .active-view {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        #tasks-view.active-view,
        #info-view.active-view {
            display: block;
        }
        
        #bottom-nav-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 15px 15px 15px;
            box-sizing: border-box;
            z-index: 999;
            animation: slideInRight 0.5s ease-out;
        }
        
        #bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            background: color-mix(in srgb, var(--secondary-bg-color) 85%, transparent);
            border: 1px solid color-mix(in srgb, var(--hint-color) 10%, transparent);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 25px;
            box-shadow: var(--shadow-lg);
        }
        
        .nav-button {
            background: transparent;
            border: none;
            color: var(--text-color);
            padding: 12px 16px;
            margin: 0 2px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-normal);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--link-color) 0%, transparent 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .nav-button.active::before {
            opacity: 0.15;
        }
        
        .nav-button.active {
            color: var(--link-color);
            transform: translateY(-2px);
        }
        
        .nav-button:hover:not(.active) {
            background: color-mix(in srgb, var(--secondary-bg-color) 70%, transparent);
            transform: translateY(-1px);
        }
        
        .nav-button:active {
            transform: scale(0.95);
        }
        
        .nav-button-icon {
            font-size: 1.3em;
            transition: all var(--transition-normal);
        }
        
        .nav-button.active .nav-button-icon {
            animation: bounce 0.6s ease;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è */
        .action-button {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--link-color), #4a90e2);
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 998;
            transition: all var(--transition-normal);
            animation: fadeIn 0.5s ease-out 0.2s both;
        }
        
        .action-button:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px color-mix(in srgb, var(--link-color) 40%, transparent);
        }
        
        .action-button:active {
            transform: scale(0.95);
        }
        
        /* –£—Ç–∏–ª–∏—Ç—ã */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--input-border-color);
            border-top-color: var(--link-color);
            border-radius: 50%;
            animation: loading 1s linear infinite;
        }
        
        .skeleton {
            background: linear-gradient(90deg, var(--secondary-bg-color) 25%, var(--input-bg-color) 50%, var(--secondary-bg-color) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--hint-color);
            animation: fadeIn 0.6s ease-out;
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
            animation: bounce 2s infinite;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∞–∂–Ω–æ—Å—Ç–∏ */
        .priority-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        .priority-high { background: var(--danger-color); box-shadow: 0 0 8px var(--danger-color); }
        .priority-medium { background: var(--warning-color); box-shadow: 0 0 6px var(--warning-color); }
        .priority-low { background: var(--success-color); box-shadow: 0 0 4px var(--success-color); }
        
        /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã */
        .fade-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease;
        }
        
        .fade-exit {
            opacity: 1;
            transform: translateY(0);
        }
        
        .fade-exit-active {
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--hint-color);
            border-radius: 3px;
            opacity: 0.5;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--link-color);
        }
    </style>
</head>
<body>

    <!-- –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è -->
    <button id="quick-action-btn" class="action-button" style="display: none;">
        <span>+</span>
    </button>

    <div id="tasks-view" class="view active-view">
        <h1 class="page-header content-padding">Task Assistant üìã</h1>
        
        <div class="form-section" id="form-section">
            <div class="form-header" onclick="toggleForm()">
                <h2 id="form-title">
                    <span id="form-icon">üí°</span> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                </h2>
                <span id="form-arrow">‚ñº</span>
            </div>
            <div class="form-section-content">
                <form id="task-form">
                    <div class="ios-group">
                        <div class="ios-row">
                            <label for="taskInput" class="ios-label">–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏</label>
                            <input type="text" id="taskInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É" required>
                        </div>
                        <div class="ios-row">
                            <label for="dateInput" class="ios-label">–î–∞—Ç–∞</label>
                            <input type="date" id="dateInput" required>
                        </div>
                        <div class="ios-row">
                            <label for="timeInput" class="ios-label">–í—Ä–µ–º—è</label>
                            <input type="time" id="timeInput" required>
                        </div>
                        <div class="ios-row">
                            <label for="importanceInput" class="ios-label">–í–∞–∂–Ω–æ—Å—Ç—å</label>
                            <select id="importanceInput" required>
                                <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                                <option value="high">–í—ã—Å–æ–∫–∞—è</option>
                                <option value="low">–ù–∏–∑–∫–∞—è</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <h2 class="content-padding" style="margin-bottom: 15px; animation: fadeIn 0.5s ease-out 0.2s both;">üìù –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
        <div id="tasks-list" class="content-padding">
            <div class="skeleton" style="height: 100px; margin: 0 15px 15px 15px; border-radius: 16px;"></div>
            <div class="skeleton" style="height: 100px; margin: 0 15px 15px 15px; border-radius: 16px;"></div>
        </div>
    </div>
    
    <div id="ai-view" class="view">
        <h1 class="page-header content-padding">AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç üß†</h1>
        
        <div id="chat-content-wrapper">
            <div id="chat-container">
                <div class="message-bubble ai-greeting">
                    –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–¥–∞—á. –°–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è, –∫–∞–∫ –ª—É—á—à–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –¥–∞–π—Ç–µ –º–Ω–µ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏!
                </div>
            </div>
        </div>
        
        <div id="chat-input-container">
            <div class="input-wrapper">
                <input type="text" id="ai-prompt-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞—á—É...">
                <button id="send-prompt-btn">
                    <span id="send-icon">üöÄ</span>
                    <span id="send-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                </button>
            </div>
        </div>
    </div>

    <div id="info-view" class="view">
        <h1 class="page-header content-padding">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚ÑπÔ∏è</h1>
        <div class="content-padding">
            <div class="empty-state">
                <div class="empty-state-icon">üì±</div>
                <h3 style="margin-bottom: 10px; color: var(--text-color);">Task AI Assistant</h3>
                <p style="margin-bottom: 20px; line-height: 1.5;">–£–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º, —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è Telegram</p>
                <div style="background: var(--secondary-bg-color); padding: 20px; border-radius: 16px; text-align: left;">
                    <p style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;"><span style="font-size: 1.2em;">‚úÖ</span> –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º</p>
                    <p style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;"><span style="font-size: 1.2em;">ü§ñ</span> –ü–æ–ª—É—á–∞–π—Ç–µ —Å–æ–≤–µ—Ç—ã –æ—Ç –ò–ò</p>
                    <p style="margin-bottom: 0; display: flex; align-items: center; gap: 10px;"><span style="font-size: 1.2em;">üéØ</span> –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</p>
                </div>
            </div>
        </div>
    </div>

    <div id="context-menu">
        <div class="menu-item" id="menu-done">
            <span>‚úÖ</span>
            <span>–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é</span>
        </div>
        <div class="menu-item" id="menu-edit">
            <span>‚úçÔ∏è</span>
            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
        </div>
        <div class="menu-item delete-item" id="menu-delete">
            <span>üóëÔ∏è</span>
            <span>–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</span>
        </div>
    </div>

    <div id="bottom-nav-container">
        <nav id="bottom-nav">
            <button class="nav-button active" data-view="tasks" onclick="navigateTo('tasks', this)">
                <span class="nav-button-icon">üìã</span>
                Tasks
            </button>
            <button class="nav-button" data-view="ai" onclick="navigateTo('ai', this)">
                <span class="nav-button-icon">üß†</span>
                AI Chat
            </button>
            <button class="nav-button" data-view="info" onclick="navigateTo('info', this)">
                <span class="nav-button-icon">‚ÑπÔ∏è</span>
                Info
            </button>
        </nav>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï N8N ---
        const N8N_GET_URL = 'https://i74s52gg.rcld.app/webhook/get-tasks'; 
        const N8N_POST_URL = 'https://i74s52gg.rcld.app/webhook/add-task'; 
        const N8N_UPDATE_URL = 'https://i74s52gg.rcld.app/webhook/update-task-status'; 
        const N8N_EDIT_URL = N8N_UPDATE_URL; 
        const N8N_DELETE_URL = 'https://i74s52gg.rcld.app/webhook/delete-task'; 
        const N8N_AI_URL = 'https://i74s52gg.rcld.app/webhook/ai-chat'; 
        const N8N_AUTH_HEADER = 'Basic YWRtaW46MzIx'; 
        // ------------------------------------------------
        
        const tasksList = document.getElementById('tasks-list');
        const taskForm = document.getElementById('task-form');
        const formSection = document.getElementById('form-section');
        const contextMenu = document.getElementById('context-menu');
        const formTitle = document.getElementById('form-title');
        const chatContainer = document.getElementById('chat-container');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const sendPromptBtn = document.getElementById('send-prompt-btn');
        const chatContentWrapper = document.getElementById('chat-content-wrapper');
        const quickActionBtn = document.getElementById('quick-action-btn');
        const sendIcon = document.getElementById('send-icon');
        const sendText = document.getElementById('send-text');

        let currentTaskId = null; 
        let isEditing = false;
        let currentEditingId = null; 
        let allTasksData = [];
        let isLoading = false;
        
        const views = document.querySelectorAll('.view');
        const navButtons = document.querySelectorAll('.nav-button');

        // --- –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò –° –ê–ù–ò–ú–ê–¶–ò–Ø–ú–ò ---
        function navigateTo(viewId, clickedButton) {
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
            const currentView = document.querySelector('.view.active-view');
            if (currentView) {
                currentView.style.animation = 'fadeIn 0.3s ease-out reverse forwards';
                setTimeout(() => {
                    currentView.classList.remove('active-view');
                    currentView.style.animation = '';
                }, 150);
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
            setTimeout(() => {
                views.forEach(view => view.classList.remove('active-view'));
                const newView = document.getElementById(viewId + '-view');
                newView.classList.add('active-view');
                newView.style.animation = 'fadeIn 0.3s ease-out forwards';

                // –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                navButtons.forEach(button => button.classList.remove('active'));
                clickedButton.classList.add('active');

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
                if (viewId === 'tasks') {
                    fetchTasks();
                    quickActionBtn.style.display = 'flex';
                    quickActionBtn.innerHTML = '<span>+</span>';
                    quickActionBtn.onclick = toggleForm;
                } else if (viewId === 'ai') {
                    quickActionBtn.style.display = 'flex';
                    quickActionBtn.innerHTML = '<span>ü§ñ</span>';
                    quickActionBtn.onclick = () => {
                        aiPromptInput.focus();
                        tg.HapticFeedback.impactOccurred('light');
                    };
                    aiPromptInput.focus();
                } else {
                    quickActionBtn.style.display = 'none';
                }

                if (viewId === 'tasks' && formSection.classList.contains('expanded')) {
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
                
                contextMenu.style.display = 'none';
                tg.HapticFeedback.selectionChanged();
            }, 150);
        }
        
        // --- –£–õ–£–ß–®–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ß–ê–¢–ê ---
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContentWrapper.scrollTop = chatContentWrapper.scrollHeight;
            return typingDiv;
        }

        function addMessageToChat(text, sender) {
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${sender}-message`;
            bubble.style.animationDelay = `${Math.random() * 0.1}s`;
            
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            chatContainer.appendChild(bubble);
            
            // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            setTimeout(() => {
                chatContentWrapper.scrollTo({
                    top: chatContentWrapper.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50);
            
            // –¢–∞–∫—Ç–∏–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
            if (sender === 'user') {
                tg.HapticFeedback.impactOccurred('light');
            }
        }

        async function sendAiPrompt() {
            const prompt = aiPromptInput.value.trim();
            if (!prompt || isLoading) return;

            addMessageToChat(prompt, 'user');
            aiPromptInput.value = '';
            aiPromptInput.disabled = true;
            sendPromptBtn.disabled = true;
            isLoading = true;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const typingIndicator = showTypingIndicator();
            
            // –ò–∑–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            sendIcon.textContent = '‚è≥';
            sendText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            try {
                const response = await fetch(N8N_AI_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': N8N_AUTH_HEADER,
                        'X-Init-Data': tg.initData,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                // –£–¥–∞–ª–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
                typingIndicator.remove();

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.response) {
                    // –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
                    const responseText = result.response;
                    const words = responseText.split(' ');
                    let currentText = '';
                    
                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'message-bubble ai-message';
                    chatContainer.appendChild(aiBubble);
                    
                    for (let i = 0; i < words.length; i++) {
                        currentText += words[i] + ' ';
                        aiBubble.innerHTML = currentText.replace(/\n/g, '<br>');
                        
                        chatContentWrapper.scrollTop = chatContentWrapper.scrollHeight;
                        
                        // –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –Ω–∞–±–æ—Ä–∞
                        await new Promise(resolve => setTimeout(resolve, Math.random() * 30 + 20));
                    }
                    
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    addMessageToChat('–û—à–∏–±–∫–∞: AI –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'ai');
                }

            } catch (error) {
                console.error('AI Chat Error:', error);
                addMessageToChat(`–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.`, 'ai');
            } finally {
                aiPromptInput.disabled = false;
                sendPromptBtn.disabled = false;
                isLoading = false;
                sendIcon.textContent = 'üöÄ';
                sendText.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                aiPromptInput.focus();
            }
        }
        
        aiPromptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAiPrompt();
            }
        });
        sendPromptBtn.addEventListener('click', sendAiPrompt);

        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
        aiPromptInput.addEventListener('focus', () => {
            aiPromptInput.style.transform = 'scale(1.02)';
        });
        
        aiPromptInput.addEventListener('blur', () => {
            aiPromptInput.style.transform = 'scale(1)';
        });

        // --- –õ–û–ì–ò–ö–ê –§–û–†–ú–´ –° –ê–ù–ò–ú–ê–¶–ò–Ø–ú–ò ---
        function toggleForm() {
            const isExpanding = !formSection.classList.contains('expanded');
            
            if (isExpanding && isEditing) {
                exitEditMode();
            }
            
            formSection.classList.toggle('expanded');
            document.getElementById('form-arrow').textContent = 
                formSection.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏
            const formIcon = document.getElementById('form-icon');
            if (isExpanding) {
                formIcon.style.transform = 'rotate(180deg)';
                formIcon.textContent = '‚úèÔ∏è';
            } else {
                formIcon.style.transform = 'rotate(0deg)';
                formIcon.textContent = 'üí°';
            }
            
            if (formSection.classList.contains('expanded')) {
                if (!isEditing) {
                    tg.MainButton.setText('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É').show();
                }
                // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
                setTimeout(() => document.getElementById('taskInput').focus(), 300);
            } else {
                tg.MainButton.hide();
            }
            
            tg.HapticFeedback.impactOccurred('light');
        }

        function enterEditMode(task) {
            if (!task) return;
            
            isEditing = true;
            currentEditingId = task.id;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            formSection.style.transform = 'scale(0.98)';
            setTimeout(() => {
                formSection.style.transform = 'scale(1)';
            }, 150);
            
            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É
            document.getElementById('taskInput').value = task.task_text || task.task;
            document.getElementById('dateInput').value = task.date;
            document.getElementById('timeInput').value = task.time;
            document.getElementById('importanceInput').value = (task.importance || 'medium').toLowerCase();
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É
            formSection.classList.add('expanded');
            document.getElementById('form-arrow').textContent = '‚ñ≤';
            formTitle.innerHTML = '<span id="form-icon" style="transform: rotate(180deg)">‚úèÔ∏è</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏';
            
            tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è').show();
            tg.HapticFeedback.notificationOccurred('success');
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Ñ–æ—Ä–º–µ
            formSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function exitEditMode() {
            isEditing = false;
            currentEditingId = null;
            taskForm.reset();
            formTitle.innerHTML = '<span id="form-icon">üí°</span> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
            tg.MainButton.setText('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É').show();
        }
        
        async function sendTask() {
            const taskName = document.getElementById('taskInput').value.trim();
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const importance = document.getElementById('importanceInput').value;
            
            if (!taskName || !date || !time) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–¥–∞—á–∏.');
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            
            const taskData = {
                taskName: taskName,
                date: date,
                time: time,
                importance: importance,
            };
            
            let url, method, isUpdate;

            if (isEditing) {
                url = N8N_EDIT_URL;
                method = 'POST';
                isUpdate = true;
                taskData.id = currentEditingId;
            } else {
                url = N8N_POST_URL;
                method = 'POST';
                isUpdate = false;
            }

            try {
                tg.MainButton.showProgress(true);
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': N8N_AUTH_HEADER,
                        'X-Init-Data': tg.initData,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });

                let result = {};
                if (response.ok) {
                    if (!isUpdate) {
                       try { result = await response.json(); } catch (e) { result = { success: true }; }
                    } else {
                       result = { success: true };
                    }
                } else {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                if (result.success || response.ok) {
                    tg.showAlert(isUpdate ? '–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    tg.HapticFeedback.notificationOccurred('success');
                    
                    if (isEditing) {
                        exitEditMode();
                    } else {
                        taskForm.reset();
                    }
                    
                    formSection.classList.remove('expanded');
                    document.getElementById('form-arrow').textContent = '‚ñº';
                    tg.MainButton.hide();

                    await fetchTasks();

                } else {
                    throw new Error(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é.');
                }

            } catch (error) {
                console.error('Operation error:', error);
                tg.showAlert(`–û—à–∏–±–∫–∞: ${error.message}`);
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                tg.MainButton.hideProgress();
            }
        }
        
        tg.MainButton.setText('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É').hide();
        tg.onEvent('mainButtonClicked', sendTask);

        // --- –£–õ–£–ß–®–ï–ù–ù–û–ï –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ ---
        function showMenu(taskId, buttonElement) {
            event.stopPropagation();
            contextMenu.style.display = 'none';
            currentTaskId = taskId;

            const rect = buttonElement.getBoundingClientRect();
            const offset = 10;

            contextMenu.style.display = 'block';
            const menuWidth = contextMenu.offsetWidth;
            const menuHeight = contextMenu.offsetHeight;

            let leftPosition = rect.right - menuWidth;
            if (leftPosition < offset) leftPosition = offset;
            if (leftPosition + menuWidth > window.innerWidth - offset) {
                leftPosition = window.innerWidth - menuWidth - offset;
            }

            let topPosition = rect.bottom + 5;
            if (topPosition + menuHeight > window.innerHeight - 80) {
                topPosition = rect.top - menuHeight - 5;
            }
            
            contextMenu.style.top = `${topPosition}px`;
            contextMenu.style.left = `${leftPosition}px`;
            
            tg.HapticFeedback.impactOccurred('light');
        }

        document.addEventListener('click', (event) => {
            if (contextMenu.style.display === 'block' && 
                !contextMenu.contains(event.target) && 
                !event.target.classList.contains('menu-button')) {
                contextMenu.style.display = 'none';
                currentTaskId = null;
            }
        });

        document.getElementById('menu-edit').addEventListener('click', () => {
            if (currentTaskId) {
                contextMenu.style.display = 'none';
                const taskToEdit = allTasksData.find(t => t.id == currentTaskId);
                if (taskToEdit) {
                    enterEditMode(taskToEdit);
                } else {
                    tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
                }
            }
        });
        
        // --- –ê–ù–ò–ú–ò–†–û–í–ê–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø –° –ó–ê–î–ê–ß–ê–ú–ò ---
        async function markTaskAsDone(taskId) {
            const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
            if (taskCard) {
                taskCard.style.animation = 'fadeIn 0.3s ease-out reverse forwards';
                setTimeout(() => {
                    taskCard.style.opacity = '0.5';
                    taskCard.style.transform = 'translateX(100px)';
                }, 150);
            }

            try {
                const response = await fetch(N8N_UPDATE_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': N8N_AUTH_HEADER,
                        'X-Init-Data': tg.initData,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: taskId, done: 'yes' })
                });
                
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                await fetchTasks();
                tg.showAlert('‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!');
                tg.HapticFeedback.notificationOccurred('success');
            } catch (error) {
                console.error('UPDATE error:', error);
                tg.showAlert(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}.`);
                if (taskCard) {
                    taskCard.style.animation = '';
                    taskCard.style.opacity = '';
                    taskCard.style.transform = '';
                }
            }
        }
        
        async function deleteTask(taskId) {
            const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
            if (taskCard) {
                taskCard.classList.add('removing');
            }

            try {
                const response = await fetch(N8N_DELETE_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': N8N_AUTH_HEADER,
                        'X-Init-Data': tg.initData,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: taskId })
                });
                
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                // –î–∞—Ç—å –≤—Ä–µ–º—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è
                setTimeout(async () => {
                    await fetchTasks();
                    tg.showAlert('üóëÔ∏è –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞!');
                    tg.HapticFeedback.notificationOccurred('warning');
                }, 300);
                
            } catch (error) {
                console.error('DELETE error:', error);
                tg.showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${error.message}.`);
                if (taskCard) {
                    taskCard.classList.remove('removing');
                }
            }
        }

        document.getElementById('menu-done').addEventListener('click', () => {
            if (currentTaskId) {
                tg.showConfirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é?', async (confirmed) => {
                    if (confirmed) {
                        contextMenu.style.display = 'none';
                        await markTaskAsDone(currentTaskId);
                    }
                });
            }
        });
        
        document.getElementById('menu-delete').addEventListener('click', () => {
            if (currentTaskId) {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?', async (confirmed) => {
                    if (confirmed) {
                        contextMenu.style.display = 'none';
                        await deleteTask(currentTaskId);
                    }
                });
            }
        });

        // --- –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ó–ê–î–ê–ß ---
        function formatTaskDateTime(dateStr, timeStr) {
            const dateOnly = new Date(dateStr);
            const timeParts = (timeStr || '00:00').split(':');

            if (isNaN(dateOnly.getTime())) {
                return { formattedText: `üìÖ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ –≤ ‚è∞ ${timeStr || '00:00'}`, isExpired: false };
            }

            const taskDateTime = new Date(dateOnly);
            taskDateTime.setHours(parseInt(timeParts[0] || 0), parseInt(timeParts[1] || 0));

            const now = new Date();
            const isExpired = taskDateTime < now;

            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const taskDateOnly = new Date(taskDateTime.getFullYear(), taskDateTime.getMonth(), taskDateTime.getDate());
            
            let dateDisplay;
            const dayDifference = Math.round((taskDateOnly.getTime() - today.getTime()) / (24 * 60 * 60 * 1000));

            if (dayDifference === 0) {
                dateDisplay = '–°–µ–≥–æ–¥–Ω—è';
            } else if (dayDifference === 1) {
                dateDisplay = '–ó–∞–≤—Ç—Ä–∞';
            } else if (dayDifference === -1) {
                dateDisplay = '–í—á–µ—Ä–∞';
            } else if (dayDifference < -1) {
                dateDisplay = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
            } else {
                const options = { day: 'numeric', month: 'short' };
                dateDisplay = taskDateOnly.toLocaleDateString('ru-RU', options).replace('.', '');
            }

            const priorityIndicator = `<span class="priority-indicator priority-${(taskData.importance || 'low').toLowerCase()}"></span>`;
            
            return { 
                formattedText: `${priorityIndicator}üìÖ ${dateDisplay} –≤ ‚è∞ ${timeStr}`, 
                isExpired: isExpired 
            };
        }

        async function fetchTasks() {
            if (!document.getElementById('tasks-view').classList.contains('active-view')) {
                return;
            }
            
            if (!tg.initData) {
                tasksList.innerHTML = '<p class="empty-message">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram</p>';
                return;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–∫–µ–ª–µ—Ç–æ–Ω—ã
            tasksList.innerHTML = `
                <div class="skeleton" style="height: 100px; margin: 0 15px 15px 15px; border-radius: 16px;"></div>
                <div class="skeleton" style="height: 100px; margin: 0 15px 15px 15px; border-radius: 16px;"></div>
            `;
            
            try {
                const response = await fetch(N8N_GET_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': N8N_AUTH_HEADER,
                        'X-Init-Data': tg.initData,
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const tasks = await response.json();

                if (!Array.isArray(tasks)) {
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç API.');
                }
                
                allTasksData = tasks;
                const activeTasks = tasks.filter(task => (task.done || 'no').toLowerCase() !== 'yes');

                if (activeTasks.length === 0) {
                    tasksList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üéâ</div>
                            <h3>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</h3>
                            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É, –Ω–∞–∂–∞–≤ –Ω–∞ —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>
                        </div>
                    `;
                    return;
                }
                
                activeTasks.sort((a, b) => {
                    const aTime = new Date(a.date + 'T' + (a.time || '00:00'));
                    const bTime = new Date(b.date + 'T' + (b.time || '00:00'));
                    return aTime - bTime;
                });

                tasksList.innerHTML = '';
                activeTasks.forEach((taskData, index) => {
                    const importance = (taskData.importance || 'low').toLowerCase();
                    const taskCard = document.createElement('div');
                    
                    const taskText = taskData.task_text || taskData.task || '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞—á–∏';
                    const dateTimeInfo = formatTaskDateTime(taskData.date, taskData.time);
                    const taskId = taskData.id;

                    let cardClasses = `task-card ${importance}`;
                    if (dateTimeInfo.isExpired) {
                        cardClasses += ' expired';
                    }
                    
                    taskCard.className = cardClasses;
                    taskCard.setAttribute('data-task-id', taskId);
                    taskCard.style.animationDelay = `${index * 0.05}s`;

                    taskCard.innerHTML = `
                        <div class="task-info">
                            <div class="task-header">
                                <span class="importance-tag ${importance}">${importance.toUpperCase()}</span>
                                <span class="task-text">${taskText}</span>
                            </div>
                            <p>${dateTimeInfo.formattedText}</p>
                        </div>
                        <button class="menu-button" onclick="event.stopPropagation(); showMenu('${taskId}', this)" title="–û–ø—Ü–∏–∏">
                            ‚ãÆ
                        </button>
                    `;
                    
                    taskCard.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('menu-button')) {
                            enterEditMode(taskData);
                        }
                    });
                    
                    tasksList.appendChild(taskCard);
                });

            } catch (error) {
                console.error('Fetch error:', error);
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                        <p>${error.message}</p>
                        <button onclick="fetchTasks()" style="margin-top: 15px; padding: 10px 20px; background: var(--link-color); color: white; border: none; border-radius: 10px; cursor: pointer;">
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                    </div>
                `;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
        function setDefaultDateTime() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const time = now.toTimeString().substring(0, 5);
            
            document.getElementById('dateInput').value = today;
            document.getElementById('timeInput').value = time;
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∫ —Å–µ–≥–æ–¥–Ω—è
            document.getElementById('dateInput').min = today;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('DOMContentLoaded', () => {
            setDefaultDateTime();
            fetchTasks();
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.3s';
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É Telegram
            if (tg.colorScheme === 'dark') {
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
            }
        });

        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
        window.markTaskAsDone = markTaskAsDone;
        window.showMenu = showMenu;
        window.toggleForm = toggleForm;
        window.enterEditMode = enterEditMode;
        window.exitEditMode = exitEditMode;
        window.navigateTo = navigateTo;
        window.deleteTask = deleteTask;
        window.sendAiPrompt = sendAiPrompt;
        window.fetchTasks = fetchTasks;
    </script>
</body>
</html>
