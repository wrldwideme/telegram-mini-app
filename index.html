<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task AI Assistant</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #777777);
            --link-color: var(--tg-theme-link-color, #007aff);
            --danger-color: #e74c3c;
            --input-bg-color: var(--tg-theme-secondary-bg-color, #ffffff); 
            --input-border-color: var(--tg-theme-hint-color, #e0e0e0); 
            --chat-bg-color: var(--tg-theme-bg-color, #f8f8f8);
            --user-bubble-color: var(--tg-theme-link-color, #007aff);
            --ai-bubble-color: var(--tg-theme-secondary-bg-color, #e5e5ea);
            --user-text-color: var(--tg-theme-bg-color, #ffffff);
            --ai-text-color: var(--tg-theme-text-color, #000000);
            /* –¶–≤–µ—Ç–∞ –≤–∞–∂–Ω–æ—Å—Ç–∏ */
            --low-color: #2ecc71;
            --medium-color: #f39c12;
            --high-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: var(--tg-theme-bg-color, #1a1a1a);
                --secondary-bg-color: var(--tg-theme-secondary-bg-color, #2a2a2a);
                --text-color: var(--tg-theme-text-color, #ecf0f1);
                --hint-color: var(--tg-theme-hint-color, #aaa);
                --input-bg-color: var(--tg-theme-secondary-bg-color, #3a3a3a);
                --input-border-color: var(--tg-theme-hint-color, #4a4a4a);
                --chat-bg-color: var(--tg-theme-bg-color, #1a1a1a);
                --ai-bubble-color: var(--tg-theme-secondary-bg-color, #3a3a3a);
                --user-text-color: var(--tg-theme-bg-color, #ffffff);
                --ai-text-color: var(--tg-theme-text-color, #ecf0f1);
                --low-color: #27ae60;
                --medium-color: #f1c40f;
                --high-color: #c0392b;
                --success-color: #27ae60;
                --warning-color: #f1c40f;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 0; 
            margin: 0;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column; /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä - flex-—Å—Ç–æ–ª–±–µ—Ü */
            touch-action: pan-y; /* –î–ª—è swipe –∂–µ—Å—Ç–æ–≤ */
        }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –°—Ç–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        .page-header {
            font-size: 1.6em;
            margin: 15px 15px 25px 15px;
            padding-bottom: 5px;
            font-weight: 700;
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç */
            background: linear-gradient(45deg, var(--link-color) 30%, #4a90e2 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-bottom: 2px solid var(--input-border-color);
        }

        /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ */
        .content-padding {
            padding: 0 15px; 
        }

        /* --- –°–¢–ò–õ–ò –ù–ê–í–ò–ì–ê–¶–ò–ò (Fix: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ View) --- */
        .view { 
            display: none; 
            flex-grow: 1;
            position: relative;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .active-view { 
            display: flex; 
            flex-direction: column; 
            flex-grow: 1;
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Fix: Tasks View –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å—Å—è —Å–∞–º –ø–æ —Å–µ–±–µ */
        #tasks-view.active-view { 
            display: block; 
            flex-grow: 1;
            overflow-y: auto; 
            padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –Ω–∏–∂–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        }
        
        /* Fix: AI View –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º —Å –æ—Ç—Å—Ç—É–ø–æ–º –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ */
        #ai-view.active-view {
            display: flex; 
            flex-direction: column; 
            flex-grow: 1;
            padding-bottom: 130px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è Chat Input Container –∏ Nav */
        }
        
        /* --- –ü–£–õ–õ-–¢–£-–†–ï–§–†–ï–® —Å—Ç–∏–ª–∏ --- */
        #pull-to-refresh {
            position: absolute;
            top: -50px;
            left: 0;
            right: 0;
            text-align: center;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--hint-color);
            font-size: 0.9em;
            z-index: 1;
            transition: transform 0.3s ease;
        }
        
        .refresh-icon {
            margin-right: 8px;
            transition: transform 0.3s ease;
        }
        
        .pull-refreshing .refresh-icon {
            animation: rotate 1s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* --- –°–¢–ò–õ–ò –ö–ê–†–¢–û–ß–ï–ö –ó–ê–î–ê–ß –ò –§–û–†–ú–´ (Tasks View) --- */
        .form-section { 
            background: transparent; 
            margin: 0 15px 20px 15px; 
            overflow: hidden; 
            transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            max-height: 60px; 
        }
        
        .form-section.expanded { max-height: 500px; }
        
        .form-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            padding: 20px; 
            height: 60px; 
            box-sizing: border-box; 
            background: var(--secondary-bg-color); 
            border-radius: 12px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            transition: background-color 0.2s; 
        }
        
        .form-section.expanded .form-header { 
            border-bottom-left-radius: 0; 
            border-bottom-right-radius: 0; 
        }
        
        .form-section-content { 
            padding: 0; 
            visibility: hidden; 
            opacity: 0; 
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out; 
            height: 0; 
            overflow: hidden; 
            background: var(--input-bg-color); 
            border-bottom-left-radius: 12px; 
            border-bottom-right-radius: 12px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
        }
        
        .form-section.expanded .form-section-content { 
            visibility: visible; 
            opacity: 1; 
            height: auto; 
            overflow: visible; 
        }
        
        .ios-group { 
            border-radius: 12px; 
            overflow: hidden; 
        }
        
        .ios-row { 
            display: flex; 
            align-items: center; 
            padding: 12px 15px; 
            border-bottom: 1px solid var(--input-border-color); 
            background: var(--input-bg-color); 
            min-height: 44px; 
            box-sizing: border-box; 
        }
        
        .ios-row:last-child { 
            border-bottom: none; 
        }
        
        .ios-label { 
            color: var(--text-color); 
            font-size: 1em; 
            font-weight: 400; 
            flex-shrink: 0; 
            width: 90px; 
            margin-right: 15px; 
        }
        
        .ios-row input, .ios-row select { 
            flex-grow: 1; 
            padding: 0; 
            margin: 0; 
            box-sizing: border-box; 
            background: transparent; 
            color: var(--text-color); 
            border: none; 
            outline: none; 
            font-size: 1em; 
            text-align: right; 
            -webkit-appearance: none; 
            -moz-appearance: none; 
            appearance: none; 
        }
        
        /* --- –ê–ù–ò–ú–ê–¶–ò–ò –î–õ–Ø –ó–ê–î–ê–ß --- */
        .task-card { 
            border-left: 6px solid #444; 
            padding: 15px; 
            margin: 0 0 15px 0; 
            border-radius: 12px; 
            background: var(--secondary-bg-color); 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            animation: slideIn 0.3s ease-out;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
        }
        
        .task-card.removing {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        .task-card.slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(-100%);
                height: 0;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .task-info { 
            flex-grow: 1; 
            margin-right: 10px; 
        }
        
        .task-header { 
            display: flex; 
            align-items: flex-start; 
            margin-bottom: 5px; 
            gap: 8px; 
        }
        
        .task-text { 
            font-weight: 600; 
            font-size: 1.15em; 
            word-wrap: break-word; 
            flex-grow: 1; 
        }
        
        .task-card p { 
            font-size: 0.9em; 
            color: var(--hint-color); 
            margin: 5px 0 0 0; 
        }
        
        /* Fix: –°—Ç–∏–ª—å –¥–ª—è —Ç–µ–≥–∞ –≤–∞–∂–Ω–æ—Å—Ç–∏ */
        .importance-tag {
            font-size: 0.75em;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 6px;
            color: var(--bg-color);
            flex-shrink: 0;
            align-self: flex-start;
            transition: transform 0.2s ease;
        }
        
        .task-card:hover .importance-tag {
            transform: scale(1.05);
        }
        
        .importance-tag.high { background-color: var(--high-color); }
        .importance-tag.medium { background-color: var(--medium-color); }
        .importance-tag.low { background-color: var(--low-color); }

        .menu-button { 
            background: transparent; 
            border: none; 
            color: var(--hint-color);
            font-size: 1.5em; 
            padding: 0 5px; 
            line-height: 1; 
            cursor: pointer;
            align-self: flex-start; 
            margin-top: -5px; 
            position: relative; 
            z-index: 1001;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        
        .menu-button:hover { 
            color: var(--link-color);
            transform: scale(1.1);
        }
        
        .menu-button:active { 
            opacity: 0.7; 
        }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ) */
        #context-menu {
            position: absolute;
            background: var(--secondary-bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; 
            overflow: hidden;
            min-width: 200px;
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .menu-item {
            padding: 12px 15px;
            font-size: 0.95em;
            cursor: pointer;
            color: var(--text-color);
            border-bottom: 1px solid var(--input-border-color);
            transition: background-color 0.1s;
        }
        
        .menu-item:last-child { 
            border-bottom: none; 
        }
        
        .menu-item:hover { 
            background-color: color-mix(in srgb, var(--secondary-bg-color) 90%, var(--link-color) 10%); 
        }
        
        .delete-item { 
            color: var(--danger-color); 
        }
        
        /* --- –°–¢–ò–õ–ò –ß–ê–¢–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–≤–æ–¥ –∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞) --- */
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        #chat-content-wrapper {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 15px; 
            scroll-behavior: smooth;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç" –¥–ª—è AI */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--ai-bubble-color);
            border-radius: 18px;
            margin: 5px 0;
            width: fit-content;
            animation: typingPulse 1.5s infinite;
        }
        
        @keyframes typingPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--hint-color);
            margin: 0 2px;
            animation: typingBounce 1.4s infinite ease-in-out both;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ –∫ –Ω–∏–∑—É */
        #chat-input-container {
            position: fixed;
            bottom: 70px; /* –í—ã—à–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏ (~60px) */
            left: 0;
            width: 100%;
            background: var(--bg-color); 
            padding: 10px 15px;
            box-sizing: border-box;
            border-top: 1px solid var(--input-border-color);
            z-index: 99;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            transition: transform 0.3s ease;
        }
        
        #chat-input-container.keyboard-active {
            transform: translateY(-250px); /* –ü–æ–¥–Ω–∏–º–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã */
        }
        
        #chat-input-container .ios-row {
            padding: 5px 15px;
            border-radius: 12px;
            background: var(--input-bg-color);
            border: 1px solid var(--input-border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s ease;
        }
        
        #chat-input-container .ios-row:focus-within {
            border-color: var(--link-color);
        }
        
        .message-bubble { 
            max-width: 85%; 
            padding: 10px 15px; 
            margin: 5px 0; 
            border-radius: 18px; 
            font-size: 0.95em; 
            line-height: 1.4; 
            word-wrap: break-word; 
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap; /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ */
            animation: messageAppear 0.3s ease-out;
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-message { 
            align-self: flex-end; 
            background-color: var(--user-bubble-color); 
            color: var(--user-text-color); 
            margin-right: 0; 
            border-bottom-right-radius: 4px; 
            margin-left: auto;
        }
        
        .ai-message { 
            align-self: flex-start; 
            background-color: var(--ai-bubble-color); 
            color: var(--ai-text-color); 
            margin-left: 0; 
            border-bottom-left-radius: 4px; 
            margin-right: auto;
        }
        
        .ai-greeting { 
            background-color: transparent; 
            color: var(--hint-color); 
            text-align: center; 
            margin: 20px auto; 
            font-style: italic; 
            box-shadow: none;
            animation: fadeIn 1s ease-out;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--secondary-bg-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .notification.success { border-left: 4px solid var(--success-color); }
        .notification.error { border-left: 4px solid var(--danger-color); }
        .notification.info { border-left: 4px solid var(--link-color); }
        
        /* --- –°–¢–ò–õ–ò –ù–ò–ñ–ù–ï–ô –ù–ê–í–ò–ì–ê–¶–ò–ò (–û—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏) --- */
        #bottom-nav-container {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%;
            padding: 5px 15px 10px 15px; 
            box-sizing: border-box; 
            z-index: 999;
        }

        #bottom-nav {
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            padding: 5px 0; 
            background: color-mix(in srgb, var(--secondary-bg-color) 80%, transparent); 
            border: 1px solid color-mix(in srgb, var(--hint-color) 10%, transparent); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px);
            border-radius: 20px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); 
        }

        .nav-button {
            background: transparent; 
            border: none; 
            color: var(--text-color);
            padding: 8px 12px; 
            margin: 0 5px; 
            font-size: 0.85em; 
            font-weight: 500; 
            cursor: pointer;
            text-align: center; 
            transition: all 0.2s ease-in-out;
            border-radius: 50px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 2px;
        }

        .nav-button.active { 
            background: var(--link-color); 
            color: var(--bg-color); 
            box-shadow: 0 2px 10px var(--link-color); 
        }
        
        .nav-button-icon { 
            font-size: 1.2em; 
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: color-mix(in srgb, var(--bg-color) 80%, transparent);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--input-border-color);
            border-top-color: var(--link-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
    </style>
</head>
<body>

    <div id="tasks-view" class="view active-view">
        <div id="pull-to-refresh">
            <span class="refresh-icon">‚Üª</span>
            <span>–ü–æ—Ç—è–Ω–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>
        </div>
        <h1 class="page-header content-padding">Task Assistant üìã</h1>
        
        <div class="form-section" id="form-section">
            <div class="form-header" onclick="toggleForm()">
                <h2 id="form-title">
                    <span id="form-icon">üí°</span> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                </h2>
                <span id="form-arrow">‚ñº</span>
            </div>
            <div class="form-section-content">
                <form id="task-form">
                    <div class="ios-group">
                        <div class="ios-row">
                            <label for="taskInput" class="ios-label">–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏</label>
                            <input type="text" id="taskInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É" required>
                        </div>
                        <div class="ios-row">
                            <label for="dateInput" class="ios-label">–î–∞—Ç–∞</label>
                            <input type="date" id="dateInput" required>
                        </div>
                        <div class="ios-row">
                            <label for="timeInput" class="ios-label">–í—Ä–µ–º—è</label>
                            <input type="time" id="timeInput" required>
                        </div>
                        <div class="ios-row">
                            <label for="importanceInput" class="ios-label">–í–∞–∂–Ω–æ—Å—Ç—å</label>
                            <select id="importanceInput" required>
                                <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                                <option value="high">–í—ã—Å–æ–∫–∞—è</option>
                                <option value="low">–ù–∏–∑–∫–∞—è</option>
                            </select>
                        </div>
                    </div> 
                </form>
            </div>
        </div>

        <h2 class="content-padding">üìù –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
        <div id="tasks-list" class="content-padding">
            <p class="loading-message">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</p>
        </div>
    </div>
    
    <div id="ai-view" class="view">
        <h1 class="page-header content-padding">AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç üß†</h1>
        
        <div id="chat-content-wrapper">
            <div id="chat-container">
                <div class="message-bubble ai-greeting">
                    –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–¥–∞—á. –°–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è, –∫–∞–∫ –ª—É—á—à–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –¥–∞–π—Ç–µ –º–Ω–µ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏!
                </div>
            </div>
        </div>
        
    </div>

    <div id="info-view" class="view">
        <h1 class="page-header content-padding">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚ÑπÔ∏è</h1>
        <div class="content-padding">
            <p class="empty-message">–†–∞–∑–¥–µ–ª —Å –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –æ Task Assistant.</p>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
    <div id="context-menu">
        <div class="menu-item" id="menu-done">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é</div>
        <div class="menu-item" id="menu-edit">‚úçÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="menu-item delete-item" id="menu-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</div>
    </div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —á–∞—Ç–∞ -->
    <div id="chat-input-container">
        <div class="ios-row">
            <input type="text" id="ai-prompt-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–¥–∞—á—É..." style="text-align: left; padding: 10px 0;">
            <button id="send-prompt-btn" class="nav-button active" style="margin-left: 10px; width: auto; padding: 5px 15px;">
                <span class="nav-button-icon">üöÄ</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notification" class="notification">
        <span id="notification-icon">‚ÑπÔ∏è</span>
        <span id="notification-text">–°–æ–æ–±—â–µ–Ω–∏–µ</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div id="bottom-nav-container">
        <nav id="bottom-nav">
            <button class="nav-button active" data-view="tasks" onclick="navigateTo('tasks', this)">
                <span class="nav-button-icon">üìã</span>
                Tasks
            </button>
            <button class="nav-button" data-view="ai" onclick="navigateTo('ai', this)">
                <span class="nav-button-icon">üß†</span>
                AI Chat
            </button>
            <button class="nav-button" data-view="info" onclick="navigateTo('info', this)">
                <span class="nav-button-icon">‚ÑπÔ∏è</span>
                Info
            </button>
        </nav>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï N8N (–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–∏ URL) ---
        const N8N_GET_URL = 'https://i74s52gg.rcld.app/webhook/get-tasks'; 
        const N8N_POST_URL = 'https://i74s52gg.rcld.app/webhook/add-task'; 
        const N8N_UPDATE_URL = 'https://i74s52gg.rcld.app/webhook/update-task-status'; 
        const N8N_EDIT_URL = N8N_UPDATE_URL; 
        const N8N_DELETE_URL = 'https://i74s52gg.rcld.app/webhook/delete-task'; 
        const N8N_AI_URL = 'https://i74s52gg.rcld.app/webhook/ai-chat'; 
        const N8N_AUTH_HEADER = 'Basic YWRtaW46MzIx'; 
        // ------------------------------------------------
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const tasksList = document.getElementById('tasks-list');
        const taskForm = document.getElementById('task-form');
        const formSection = document.getElementById('form-section');
        const contextMenu = document.getElementById('context-menu');
        const formTitle = document.getElementById('form-title');
        const chatContainer = document.getElementById('chat-container');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const sendPromptBtn = document.getElementById('send-prompt-btn');
        const chatContentWrapper = document.getElementById('chat-content-wrapper');
        const chatInputContainer = document.getElementById('chat-input-container');
        const notification = document.getElementById('notification');
        const loadingOverlay = document.getElementById('loading-overlay');
        const pullToRefresh = document.getElementById('pull-to-refresh');

        // --- –õ–û–ö–ê–õ–¨–ù–û–ï –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ---
        let tasksCache = {
            data: null,
            timestamp: 0,
            userId: null
        };
        const CACHE_TTL = 30000; // 30 —Å–µ–∫—É–Ω–¥
        
        // --- DEBOUNCE –¢–ê–ô–ú–ï–†–´ ---
        let fetchTasksDebounceTimer;
        let searchDebounceTimer;
        let notificationTimer;
        
        // --- –°–¢–ï–ô–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        let currentTaskId = null; 
        let isEditing = false;
        let currentEditingId = null; 
        let allTasksData = [];
        let isRefreshing = false;
        let touchStart = { x: 0, y: 0 };
        let currentView = 'tasks';
        
        const views = document.querySelectorAll('.view');
        const navButtons = document.querySelectorAll('.nav-button');

        // --- –£–¢–ò–õ–ò–¢–´ ---
        
        // –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(fetchTasksDebounceTimer);
                fetchTasksDebounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤–≤–æ–¥–∞
        function sanitizeInput(text, maxLength = 1000) {
            if (!text) return '';
            return text
                .replace(/[<>]/g, '') // –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
                .trim()
                .substring(0, maxLength);
        }
        
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'info', duration = 3000) {
            clearTimeout(notificationTimer);
            
            notification.className = `notification ${type}`;
            notification.querySelector('#notification-text').textContent = message;
            
            let icon = '‚ÑπÔ∏è';
            switch(type) {
                case 'success': icon = '‚úÖ'; break;
                case 'error': icon = '‚ùå'; break;
                case 'warning': icon = '‚ö†Ô∏è'; break;
            }
            notification.querySelector('#notification-icon').textContent = icon;
            
            notification.classList.add('show');
            
            notificationTimer = setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        function setLoading(show) {
            if (show) {
                loadingOverlay.classList.add('show');
            } else {
                loadingOverlay.classList.remove('show');
            }
        }
        
        // --- –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò –° SWIPE –ñ–ï–°–¢–ê–ú–ò ---
        
        function navigateTo(viewId, clickedButton) {
            currentView = viewId;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
            views.forEach(view => {
                view.classList.remove('active-view');
            });
            
            const targetView = document.getElementById(viewId + '-view');
            targetView.classList.add('active-view');

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            navButtons.forEach(button => {
                button.classList.remove('active');
            });
            clickedButton.classList.add('active');
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
            const isTaskViewActive = viewId === 'tasks';
            const isFormExpanded = formSection.classList.contains('expanded');
            const isAiViewActive = viewId === 'ai';

            // MainButton
            if (isTaskViewActive && isFormExpanded) {
                tg.MainButton.show();
            } else {
                tg.MainButton.hide(); 
            }
            
            // –ü–æ–ª–µ –≤–≤–æ–¥–∞ —á–∞—Ç–∞
            if (isAiViewActive) {
                chatInputContainer.style.display = 'block';
                setTimeout(() => {
                    chatContentWrapper.scrollTop = chatContentWrapper.scrollHeight;
                    aiPromptInput.focus();
                }, 100);
            } else {
                chatInputContainer.style.display = 'none';
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–∞
            if (isTaskViewActive) {
                fetchTasks();
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
            contextMenu.style.display = 'none';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è swipe –∂–µ—Å—Ç–æ–≤
        function initSwipeGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            
            document.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            });
            
            document.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
            });
        }
        
        function handleSwipe(startX, startY, endX, endY) {
            const minSwipeDistance = 50;
            const deltaX = endX - startX;
            const deltaY = endY - startY;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–≤–∞–π–ø –±—ã–ª –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º, –∞ –Ω–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–º
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                const viewsOrder = ['tasks', 'ai', 'info'];
                const currentIndex = viewsOrder.indexOf(currentView);
                
                if (deltaX > 0 && currentIndex > 0) {
                    // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–∏–¥
                    const prevView = viewsOrder[currentIndex - 1];
                    const button = document.querySelector(`.nav-button[data-view="${prevView}"]`);
                    navigateTo(prevView, button);
                    tg.HapticFeedback.impactOccurred('light');
                } else if (deltaX < 0 && currentIndex < viewsOrder.length - 1) {
                    // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - —Å–ª–µ–¥—É—é—â–∏–π –≤–∏–¥
                    const nextView = viewsOrder[currentIndex + 1];
                    const button = document.querySelector(`.nav-button[data-view="${nextView}"]`);
                    navigateTo(nextView, button);
                    tg.HapticFeedback.impactOccurred('light');
                }
            }
        }
        
        // --- –ü–£–õ–õ-–¢–£-–†–ï–§–†–ï–® ---
        
        function initPullToRefresh() {
            let startY = 0;
            let currentY = 0;
            let isPulling = false;
            
            const tasksView = document.getElementById('tasks-view');
            
            tasksView.addEventListener('touchstart', e => {
                if (tasksView.scrollTop === 0) {
                    startY = e.touches[0].clientY;
                    isPulling = true;
                }
            });
            
            tasksView.addEventListener('touchmove', e => {
                if (!isPulling) return;
                
                currentY = e.touches[0].clientY;
                const pullDistance = currentY - startY;
                
                if (pullDistance > 0) {
                    e.preventDefault();
                    const pullProgress = Math.min(pullDistance / 100, 1);
                    pullToRefresh.style.transform = `translateY(${pullDistance}px)`;
                    pullToRefresh.style.opacity = pullProgress;
                    
                    if (pullDistance > 80 && !isRefreshing) {
                        startRefresh();
                    }
                }
            });
            
            tasksView.addEventListener('touchend', () => {
                if (isPulling) {
                    isPulling = false;
                    pullToRefresh.style.transform = 'translateY(0)';
                    pullToRefresh.style.opacity = '0';
                    pullToRefresh.classList.remove('pull-refreshing');
                }
            });
        }
        
        function startRefresh() {
            isRefreshing = true;
            pullToRefresh.classList.add('pull-refreshing');
            pullToRefresh.querySelector('span:nth-child(2)').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            
            fetchTasks(true).finally(() => {
                setTimeout(() => {
                    isRefreshing = false;
                    pullToRefresh.classList.remove('pull-refreshing');
                    pullToRefresh.querySelector('span:nth-child(2)').textContent = '–ü–æ—Ç—è–Ω–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
                }, 1000);
            });
        }
        
        // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê –° –ò–ù–î–ò–ö–ê–¢–û–†–û–ú –ó–ê–ì–†–£–ó–ö–ò ---
        
        function addMessageToChat(text, sender) {
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${sender}-message`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            chatContainer.appendChild(bubble);
            chatContentWrapper.scrollTop = chatContentWrapper.scrollHeight;
        }
        
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator ai-message';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContentWrapper.scrollTop = chatContentWrapper.scrollHeight;
            return typingDiv;
        }
        
        async function sendAiPrompt() {
            const prompt = sanitizeInput(aiPromptInput.value);
            if (!prompt) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
                return;
            }

            addMessageToChat(prompt, 'user');
            aiPromptInput.value = ''; 
            aiPromptInput.disabled = true;
            sendPromptBtn.disabled = true;

            const typingIndicator = showTypingIndicator();

            try {
                const response = await fetch(N8N_AI_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': N8N_AUTH_HEADER,
                        'X-Init-Data': tg.initData,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                
                typingIndicator.remove();
                
                if (result.success && result.response) {
                    addMessageToChat(result.response, 'ai');
                } else {
                    addMessageToChat('–û—à–∏–±–∫–∞: AI –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.', 'ai');
                    showNotification('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞', 'error');
                }

            } catch (error) {
                console.error('AI Chat Error:', error);
                typingIndicator.remove();
                addMessageToChat('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'ai');
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            } finally {
                aiPromptInput.disabled = false;
                sendPromptBtn.disabled = false;
                aiPromptInput.focus();
                chatContentWrapper.scrollTop = chatContentWrapper.scrollHeight;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        function handleKeyboard() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                aiPromptInput.addEventListener('focus', () => {
                    chatInputContainer.classList.add('keyboard-active');
                    setTimeout(() => {
                        chatContentWrapper.scrollTop = chatContentWrapper.scrollHeight;
                    }, 300);
                });
                
                aiPromptInput.addEventListener('blur', () => {
                    chatInputContainer.classList.remove('keyboard-active');
                });
            }
        }
        
        // --- –õ–û–ì–ò–ö–ê –ó–ê–î–ê–ß –° –ö–≠–®–ò–†–û–í–ê–ù–ò–ï–ú –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ï–ô ---
        
        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–¥–∞—á
        function renderTasks(tasks) {
            const fragment = document.createDocumentFragment();
            
            tasks.forEach(taskData => {
                const taskCard = createTaskCardElement(taskData);
                fragment.appendChild(taskCard);
            });
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            requestAnimationFrame(() => {
                tasksList.innerHTML = '';
                tasksList.appendChild(fragment);
            });
        }
        
        function createTaskCardElement(taskData) {
            const importance = (taskData.importance || 'low').toLowerCase();
            const taskCard = document.createElement('div');
            
            const taskText = sanitizeInput(taskData.task_text || taskData.task || '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞—á–∏');
            const dateTimeInfo = formatTaskDateTime(taskData.date, taskData.time);
            const taskId = taskData.id; 

            let cardClasses = `task-card ${importance}`;
            if (dateTimeInfo.isExpired) {
                cardClasses += ' expired';
            }
            
            taskCard.className = cardClasses;
            taskCard.setAttribute('data-task-id', taskId);
            
            taskCard.innerHTML = `
                <div class="task-info">
                    <div class="task-header">
                        <span class="importance-tag ${importance}">${importance.toUpperCase()}</span> 
                        <span class="task-text">${taskText}</span>
                    </div>
                    <p>${dateTimeInfo.formattedText}</p>
                </div>
                <button class="menu-button" onclick="event.stopPropagation(); showMenu('${taskId}', this)" title="–û–ø—Ü–∏–∏">
                    ‚ãÆ
                </button>
            `;
            
            return taskCard;
        }
        
        // –î–µ–±–∞—É–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
        const debouncedFetchTasks = debounce((forceRefresh = false) => {
            fetchTasks(forceRefresh);
        }, 300);
        
        async function fetchTasks(forceRefresh = false) {
            if (!document.getElementById('tasks-view').classList.contains('active-view') && !forceRefresh) {
                return;
            }
            
            if (!tg.initData) {
                showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
            const now = Date.now();
            const userId = tg.initDataUnsafe.user?.id || 'unknown';
            
            if (!forceRefresh && 
                tasksCache.data && 
                tasksCache.userId === userId &&
                (now - tasksCache.timestamp) < CACHE_TTL) {
                renderTasks(tasksCache.data);
                return;
            }
            
            setLoading(true);
            
            try {
                const response = await fetch(N8N_GET_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': N8N_AUTH_HEADER,
                        'X-Init-Data': tg.initData,
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const tasks = await response.json();

                if (!Array.isArray(tasks)) {
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
                
                allTasksData = tasks; 
                
                const activeTasks = tasks.filter(task => (task.done || 'no').toLowerCase() !== 'yes');

                if (activeTasks.length === 0) {
                    tasksList.innerHTML = '<p class="empty-message">üéâ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á. –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç!</p>';
                    tasksCache.data = [];
                    tasksCache.timestamp = now;
                    tasksCache.userId = userId;
                    return;
                }
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                activeTasks.sort((a, b) => {
                    const aTimeStr = a.date + ' ' + (a.time || '00:00');
                    const bTimeStr = b.date + ' ' + (b.time || '00:00');

                    const aDate = new Date(aTimeStr);
                    const bDate = new Date(bTimeStr);
                    
                    if (isNaN(aDate.getTime())) return 1; 
                    if (isNaN(bDate.getTime())) return -1;
                    
                    return aDate.getTime() - bDate.getTime();
                });
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
                tasksCache.data = activeTasks;
                tasksCache.timestamp = now;
                tasksCache.userId = userId;
                
                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
                renderTasks(activeTasks);
                
            } catch (error) {
                console.error('Fetch error:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á', 'error');
                
                // –ü–æ–∫–∞–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—à–∏–±–∫–µ
                if (tasksCache.data && tasksCache.data.length > 0) {
                    renderTasks(tasksCache.data);
                    showNotification('–ü–æ–∫–∞–∑–∞–Ω—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'warning');
                } else {
                    tasksList.innerHTML = '<p class="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏</p>';
                }
            } finally {
                setLoading(false);
            }
        }
        
        // --- –û–°–¢–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π) ---
        
        function toggleForm() {
            if (formSection.classList.contains('expanded') && isEditing) {
                exitEditMode(); 
            }
            formSection.classList.toggle('expanded');
            document.getElementById('form-arrow').textContent = formSection.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
            
            if (formSection.classList.contains('expanded')) {
                 if (!isEditing) {
                    tg.MainButton.setText('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É').show();
                }
            } else {
                tg.MainButton.hide(); 
            }
        }
        
        function enterEditMode(task) {
            if (!task) return;
            
            isEditing = true;
            currentEditingId = task.id;
            
            document.getElementById('taskInput').value = sanitizeInput(task.task_text || task.task);
            document.getElementById('dateInput').value = task.date;
            document.getElementById('timeInput').value = task.time;
            document.getElementById('importanceInput').value = (task.importance || 'medium').toLowerCase();
            
            formSection.classList.add('expanded');
            document.getElementById('form-arrow').textContent = '‚ñ≤';
            formTitle.innerHTML = '<span id="form-icon">üìù</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏';
            
            tg.MainButton.setText('‚úçÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è').show();
            tg.HapticFeedback.notificationOccurred('success');
        }
        
        function exitEditMode() {
            isEditing = false;
            currentEditingId = null;
            taskForm.reset(); 
            formTitle.innerHTML = '<span id="form-icon">üí°</span> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
            tg.MainButton.setText('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É').show();
        }
        
        async function sendTask() {
            const taskName = sanitizeInput(document.getElementById('taskInput').value);
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const importance = document.getElementById('importanceInput').value;
            
            if (!taskName || !date || !time) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'warning');
                return;
            }
            
            const taskData = {
                taskName: taskName,
                date: date,
                time: time,
                importance: importance,
            };
            
            let url, isUpdate;

            if (isEditing) {
                url = N8N_EDIT_URL;
                isUpdate = true;
                taskData.id = currentEditingId; 
            } else {
                url = N8N_POST_URL;
                isUpdate = false;
            }

            try {
                tg.MainButton.showProgress(true); 
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': N8N_AUTH_HEADER,
                        'X-Init-Data': tg.initData,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    showNotification(isUpdate ? '–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!', 'success');
                    
                    if (isEditing) {
                        exitEditMode(); 
                    } else {
                        taskForm.reset(); 
                    }
                    
                    formSection.classList.remove('expanded'); 
                    document.getElementById('form-arrow').textContent = '‚ñº';
                    tg.MainButton.hide(); 

                    // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
                    tasksCache.data = null;
                    await fetchTasks(true);

                } else {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

            } catch (error) {
                console.error('Operation error:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏', 'error');
            } finally {
                tg.MainButton.hideProgress();
            }
        }
        
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        
        tg.MainButton.setText('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É').hide(); 
        tg.onEvent('mainButtonClicked', sendTask);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        aiPromptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAiPrompt();
            }
        });
        
        sendPromptBtn.addEventListener('click', sendAiPrompt);
        
        document.getElementById('menu-done').addEventListener('click', () => {
            if (currentTaskId) {
                markTaskAsDone(currentTaskId);
            }
        });
        
        document.getElementById('menu-edit').addEventListener('click', () => {
            if (currentTaskId) {
                contextMenu.style.display = 'none';
                const taskToEdit = allTasksData.find(t => t.id == currentTaskId);
                if (taskToEdit) {
                    enterEditMode(taskToEdit);
                } else {
                    showNotification('–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                }
            }
        });
        
        document.getElementById('menu-delete').addEventListener('click', () => {
            if (currentTaskId) {
                deleteTask(currentTaskId);
            }
        });
        
        document.addEventListener('click', (event) => {
            if (contextMenu.style.display === 'block' && 
                !contextMenu.contains(event.target) && 
                !event.target.classList.contains('menu-button')) {
                contextMenu.style.display = 'none';
                currentTaskId = null;
            }
        });
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function formatTaskDateTime(dateStr, timeStr) {
            const dateOnly = parseDate(dateStr);
            const timeParts = (timeStr || '00:00').split(':');

            if (!dateOnly) {
                const formattedTime = timeStr || '00:00';
                return { formattedText: `üìÖ –ù–ï–í–ï–†–ù–ê–Ø –î–ê–¢–ê –≤ ‚è∞ ${formattedTime}`, isExpired: false };
            }

            const taskDateTime = new Date(dateOnly.getTime()); 
            taskDateTime.setHours(taskDateTime.getHours() + (new Date().getTimezoneOffset() / 60)); 
            taskDateTime.setHours(taskDateTime.getHours() + parseInt(timeParts[0] || 0));
            taskDateTime.setMinutes(taskDateTime.getMinutes() + parseInt(timeParts[1] || 0));

            const now = new Date();
            const isExpired = taskDateTime < now;

            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const taskDateOnly = new Date(taskDateTime.getFullYear(), taskDateTime.getMonth(), taskDateTime.getDate());
            
            let dateDisplay;
            const dayDifference = Math.round((taskDateOnly.getTime() - today.getTime()) / (24 * 60 * 60 * 1000));

            if (dayDifference === 0) {
                dateDisplay = '–°–µ–≥–æ–¥–Ω—è';
            } else if (dayDifference === 1) {
                dateDisplay = '–ó–∞–≤—Ç—Ä–∞';
            } else {
                const options = { day: 'numeric', month: 'short' };
                dateDisplay = taskDateOnly.toLocaleDateString('ru-RU', options).toUpperCase().replace(/\./g, '');
            }

            return { 
                formattedText: `üìÖ ${dateDisplay} –≤ ‚è∞ ${timeStr}`, 
                isExpired: isExpired 
            };
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if (parts.length === 3 && parts[0].length === 4) {
                    return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                }
            }
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }
        
        async function markTaskAsDone(taskId) {
            const performUpdate = async () => {
                try {
                    tg.MainButton.showProgress(true); 
                    const response = await fetch(N8N_UPDATE_URL, {
                        method: 'POST', 
                        headers: {
                            'Authorization': N8N_AUTH_HEADER,
                            'X-Init-Data': tg.initData,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: taskId, done: 'yes' })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
                    const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        taskCard.classList.add('removing');
                        setTimeout(() => {
                            tasksCache.data = null;
                            fetchTasks(true);
                        }, 300);
                    } else {
                        tasksCache.data = null;
                        await fetchTasks(true);
                    }
                    
                    showNotification('–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!', 'success');
                } catch (error) {
                    console.error('UPDATE error:', error);
                    showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
                } finally {
                    tg.MainButton.hideProgress();
                }
            };
            
            tg.showConfirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é?', async (confirmed) => {
                if (confirmed) {
                    contextMenu.style.display = 'none'; 
                    await performUpdate();
                }
            });
        }
        
        async function deleteTask(taskId) {
            if (!taskId) return;
            
            tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?', async (confirmed) => {
                if (confirmed) {
                    contextMenu.style.display = 'none';
                    try {
                        tg.MainButton.showProgress(true); 
                        const response = await fetch(N8N_DELETE_URL, {
                            method: 'POST', 
                            headers: {
                                'Authorization': N8N_AUTH_HEADER,
                                'X-Init-Data': tg.initData,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ id: taskId })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
                        const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                        if (taskCard) {
                            taskCard.classList.add('removing');
                            setTimeout(() => {
                                tasksCache.data = null;
                                fetchTasks(true);
                            }, 300);
                        } else {
                            tasksCache.data = null;
                            await fetchTasks(true);
                        }
                        
                        showNotification('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞!', 'success');
                    } catch (error) {
                        console.error('DELETE error:', error);
                        showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                    } finally {
                        tg.MainButton.hideProgress();
                    }
                }
            });
        }
        
        function showMenu(taskId, buttonElement) {
            contextMenu.style.display = 'none';
            currentTaskId = taskId; 

            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const rect = buttonElement.getBoundingClientRect();
            const offset = 10; 

            contextMenu.style.display = 'block';
            const menuWidth = contextMenu.offsetWidth; 
            const menuHeight = contextMenu.offsetHeight; 

            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            let leftPosition = rect.right - menuWidth; 
            if (leftPosition < offset) {
                leftPosition = offset;
            }
            if (leftPosition + menuWidth > viewportWidth - offset) {
                leftPosition = viewportWidth - menuWidth - offset;
            }

            let topPosition = rect.bottom + 5; 
            if (topPosition + menuHeight > viewportHeight - 80) { 
                topPosition = rect.top - menuHeight - 5;
                if (topPosition < 0) { 
                    topPosition = rect.bottom + 5;
                }
            }
            
            contextMenu.style.top = `${topPosition}px`; 
            contextMenu.style.left = `${leftPosition}px`;
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.markTaskAsDone = markTaskAsDone;
        window.showMenu = showMenu;
        window.toggleForm = toggleForm;
        window.enterEditMode = enterEditMode; 
        window.exitEditMode = exitEditMode; 
        window.navigateTo = navigateTo; 
        window.deleteTask = deleteTask; 
        window.sendAiPrompt = sendAiPrompt;
        window.fetchTasks = () => fetchTasks(true);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo('tasks', document.querySelector('.nav-button[data-view="tasks"]'));
            initSwipeGestures();
            initPullToRefresh();
            handleKeyboard();
            
            // –ê–≤—Ç–æ-—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ AI —á–∞—Ç–∞
            aiPromptInput.addEventListener('focus', () => {
                setTimeout(() => {
                    chatContentWrapper.scrollTop = chatContentWrapper.scrollHeight;
                }, 100);
            });
        });
        
    </script>
</body>
</html>
